# 提示词优化工具 - 代码架构图

## 一、项目目录结构

```
prompt_optimizer/
├── config/                     # 配置模块
│   ├── __init__.py
│   └── settings.py
├── src/                        # 源代码
│   ├── core/                  # 核心业务逻辑
│   │   ├── optimizer.py
│   │   └── prompt_templates.py
│   ├── models/                # AI模型层
│   │   └── ai_models.py
│   └── utils/                 # 工具层
│       ├── auth.py
│       ├── database.py
│       └── logger.py
├── static/                     # 前端静态文件
│   ├── index.html
│   ├── login.html
│   ├── style.css
│   └── script.js
├── app.py                      # Flask主程序
└── init_db.py                  # 数据库初始化
```

## 二、系统架构图

### 2.1 三层架构

```
┌─────────────────────────────────────────────────────────────┐
│                        表现层 (Presentation)                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Web前端 (HTML/CSS/JavaScript)                        │   │
│  │  - login.html  - index.html                          │   │
│  │  - script.js   - style.css                           │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕ REST API
┌─────────────────────────────────────────────────────────────┐
│                    业务逻辑层 (Business Logic)                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Flask (app.py) - 17个API端点                        │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  核心模块                                             │   │
│  │  - OptimizerCore  - AIModelManager                  │   │
│  │  - AuthService                                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕ DAO
┌─────────────────────────────────────────────────────────────┐
│                      数据访问层 (Data Access)                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  DAO: UserDAO, SessionDAO, ConversationDAO          │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  MySQL数据库                                          │   │
│  │  users | sessions | conversations | results         │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 组件交互图

```mermaid
graph TB
    subgraph "前端层"
        UI[Web界面]
    end
    
    subgraph "API层"
        Auth[认证API]
        Session[会话API]
        Conv[对话API]
        Opt[优化API]
    end
    
    subgraph "业务层"
        AuthSvc[AuthService]
        OptimizerCore[OptimizerCore]
        AIManager[AIModelManager]
    end
    
    subgraph "数据层"
        UserDAO[UserDAO]
        SessionDAO[SessionDAO]
        ConvDAO[ConversationDAO]
    end
    
    subgraph "存储"
        MySQL[(MySQL)]
    end
    
    subgraph "外部"
        DeepSeek[DeepSeek]
        Kimi[Kimi]
        Qwen[Qwen]
    end
    
    UI --> Auth
    UI --> Session
    UI --> Conv
    UI --> Opt
    
    Auth --> AuthSvc
    Session --> SessionDAO
    Conv --> ConvDAO
    Opt --> OptimizerCore
    
    AuthSvc --> UserDAO
    OptimizerCore --> AIManager
    OptimizerCore --> ConvDAO
    
    AIManager --> DeepSeek
    AIManager --> Kimi
    AIManager --> Qwen
    
    UserDAO --> MySQL
    SessionDAO --> MySQL
    ConvDAO --> MySQL
```

## 三、核心流程图

### 3.1 用户登录流程

```mermaid
sequenceDiagram
    actor 用户
    participant 前端
    participant API
    participant AuthService
    participant MySQL
    
    用户->>前端: 输入用户名密码
    前端->>API: POST /api/auth/login
    API->>AuthService: login()
    AuthService->>MySQL: 查询用户
    MySQL-->>AuthService: 用户数据
    AuthService->>AuthService: 验证密码
    
    alt 验证成功
        AuthService-->>API: success
        API-->>前端: 返回token
        前端->>前端: 跳转主页
    else 验证失败
        AuthService-->>API: error
        API-->>前端: 401
        前端->>用户: 显示错误
    end
```

### 3.2 三模型协作优化流程

```mermaid
sequenceDiagram
    actor 用户
    participant 前端
    participant API
    participant OptimizerCore
    participant DeepSeek
    participant Kimi
    participant Qwen
    
    用户->>前端: 输入需求
    前端->>API: POST /api/optimize
    API->>OptimizerCore: 执行优化
    
    rect rgb(240, 248, 255)
        OptimizerCore->>DeepSeek: Step 1
        DeepSeek-->>OptimizerCore: 结果1
    end
    
    rect rgb(255, 248, 240)
        OptimizerCore->>Kimi: Step 2
        Kimi-->>OptimizerCore: 结果2
    end
    
    rect rgb(240, 255, 240)
        OptimizerCore->>Qwen: Step 3
        Qwen-->>OptimizerCore: 结果3
    end
    
    OptimizerCore-->>API: 三个结果
    API-->>前端: 返回结果
    前端->>用户: 展示结果
```

### 3.3 数据库表关系

```mermaid
erDiagram
    users ||--o{ sessions : "1:N"
    sessions ||--o{ conversations : "1:N"
    sessions ||--o{ optimization_results : "1:N"
    
    users {
        int id PK
        string username UK
        string password_hash
        timestamp created_at
    }
    
    sessions {
        int id PK
        int user_id FK
        string session_name
        text initial_requirement
        boolean is_active
    }
    
    conversations {
        int id PK
        int session_id FK
        int turn_number
        text user_message
        text ai_response
    }
    
    optimization_results {
        int id PK
        int session_id FK
        text original_prompt
        text deepseek_result
        text kimi_result
        text qwen_result
    }
```
